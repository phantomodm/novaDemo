<mat-toolbar color="primary" class="main-toolbar">
  <button mat-icon-button (click)="leftSidenav.toggle()">
    <mat-icon>menu</mat-icon>
  </button>
  <h1>Continuity Engine</h1>
  <span class="toolbar-spacer"></span>
  <div class="global-status">
    <mat-icon class="status-icon-stable">check_circle</mat-icon>
    <span>Global Status: STABLE</span>
  </div>
  <button mat-icon-button>
    <mat-icon>account_circle</mat-icon>
  </button>
</mat-toolbar>
<mat-sidenav-container class="sidenav-container">
    <!-- Left Sidenav (Control Panel) -->
      <mat-sidenav #leftSidenav mode="side" opened="true" class="sidenav">
        <mat-card class="control-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>update</mat-icon>
            <mat-card-title>Live Forecast</mat-card-title>
            <mat-card-subtitle>Last Updated: 16-Oct-2025 14:32 UTC</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p class="legend-title">Legend</p>
            <mat-list role="list">
              <mat-list-item role="listitem"><mat-icon class="legend-icon unstable">square</mat-icon> <span style="color:white">Unstable (CI < 0.1)</span></mat-list-item>
              <mat-list-item role="listitem"><mat-icon class="legend-icon warning">square</mat-icon> <span style="color:white">Elevated Risk (CI < 0.5)</span></mat-list-item>
              <mat-list-item role="listitem"><mat-icon class="legend-icon stable">square</mat-icon> <span style="color:white">Stable (CI > 0.8)</span></mat-list-item>
            </mat-list>
          </mat-card-content>
        </mat-card>

        <mat-card class="control-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>science</mat-icon>
            <mat-card-subtitle>Historical Backtest</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <!-- <mat-form-field class="full-width">
              <mat-label class="placeholder">Search Events by Name</mat-label>
              <input matInput placeholder="e.g., Tohoku, Chile">
            </mat-form-field> -->
            <mat-form-field class="full-width" appearance="fill">
              <mat-label>Search Historical Events</mat-label>
              <input type="text" matInput [formControl]="searchControl" [matAutocomplete]="auto">
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayEvent">
                @for(event of (filteredEvents$ | async); track event){
                  <mat-option  [value]="event">
                  {{event.name}}
                </mat-option>
                }
                
              </mat-autocomplete>
            </mat-form-field>
            <mat-label>Months Before Event: {{ monthsBefore }}</mat-label>
            <mat-slider min="1" max="24" step="1" discrete>
              <input matSliderThumb [(ngModel)]="monthsBefore">
            </mat-slider>
            <button mat-flat-button color="accent" class="full-width" (click)="runBacktest()">
              Run Backtest
            </button>
          </mat-card-content>
        </mat-card>
      </mat-sidenav>
      <!-- Main Content (Globe) -->
      <mat-sidenav-content class="main-content">
        <!-- This div is the target for our Cesium globe -->
         <!-- <div id="cesium" #cesiumContainer class="globe-container"></div> -->
        <div #cesiumContainer class="globe-container"></div>
      </mat-sidenav-content>
      <!-- Right Sidenav (Information Panel) -->
      <mat-sidenav #rightSidenav mode="over" position="end" class="sidenav info-panel">
        @if(backtestState === 'processing') {
          <div>
            <mat-card class="info-card">
              <mat-card-header><mat-card-title>Backtest in Progress</mat-card-title></mat-card-header>
              <mat-card-content class="processing-content">
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                <p>Job ID: {{ backtestJobId }}</p>
                <p>Status: Processing ⏳</p>
              </mat-card-content>
            </mat-card>
          </div>
        }
        
        @if(backtestState === 'complete' && backtestResult){
          <div>
          <mat-card class="info-card">
            <mat-card-header>
               <mat-card-title>Backtest Complete ✅</mat-card-title>
               <mat-card-subtitle>Event: {{ backtestResult.event_details.name }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <p><strong>Date:</strong> {{ backtestResult.event_details.date }} | <strong>Mag:</strong> {{ backtestResult.event_details.mag }}</p>
                <!-- Image is now clickable to open the modal -->
                <img [src]="backtestPlot" alt="Backtest CI Chart" class="chart-image clickable" (click)="openChartModal()">
            </mat-card-content>
          </mat-card>
        </div>
        }

        @if(selectedCell){
          <!-- NEW: Panel for Selected Grid Cell -->
          <div>
            <mat-card class="info-card">
              <mat-card-header>
                <mat-card-title>Grid Cell Analysis</mat-card-title>
                <mat-card-subtitle>Forecast Time: {{ selectedCell.forecast_time | date:'short' }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                  <p><strong>Continuity Index:</strong> {{ selectedCell.continuity_index.toFixed(4) }}</p>
                  <p><strong>Status:</strong> <span [ngClass]="selectedCell.status === 'UNSTABLE' ? 'status-unstable' : 'status-stable'">{{ selectedCell.status }}</span></p>
                  <!-- In the future, a historical chart for this cell would go here -->
              </mat-card-content>
            </mat-card>
          </div>
        }
        
      </mat-sidenav>
</mat-sidenav-container>

